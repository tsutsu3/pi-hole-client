import 'dart:convert';
import 'package:shelf/shelf.dart';
import 'package:shelf_router/shelf_router.dart';

class PiholeV5Handler {
  Router get router {
    final router = Router();

    router.get('/api.php', (Request req) {
      final qp = req.url.queryParameters;

      // ------ enable / disable ------
      if (qp.containsKey('enable')) {
        // e.g. enable, enable=0
        return Response.ok(jsonEncode({'status': 'enabled'}));
      }
      if (qp.containsKey('disable')) {
        // e.g. disable=5
        return Response.ok(jsonEncode({'status': 'disabled'}));
      }

      // ------ summaryRaw only ------
      if (qp.containsKey('summaryRaw') &&
          !qp.containsKey('topItems') &&
          !qp.containsKey('getForwardDestinations') &&
          !qp.containsKey('getQuerySources') &&
          !qp.containsKey('topClientsBlocked') &&
          !qp.containsKey('getQueryTypes')) {
        // http://example.com/admin/api.php?auth=xxx123&summaryRaw
        return Response.ok(
          jsonEncode({
            'domains_being_blocked': 121,
            'dns_queries_today': 12,
            'ads_blocked_today': 1,
            'ads_percentage_today': 8.333333,
            'unique_domains': 11,
            'queries_forwarded': 9,
            'queries_cached': 2,
            'clients_ever_seen': 2,
            'unique_clients': 2,
            'dns_queries_all_types': 12,
            'reply_UNKNOWN': 0,
            'reply_NODATA': 0,
            'reply_NXDOMAIN': 1,
            'reply_CNAME': 0,
            'reply_IP': 10,
            'reply_DOMAIN': 1,
            'reply_RRNAME': 0,
            'reply_SERVFAIL': 0,
            'reply_REFUSED': 0,
            'reply_NOTIMP': 0,
            'reply_OTHER': 0,
            'reply_DNSSEC': 0,
            'reply_NONE': 0,
            'reply_BLOB': 0,
            'dns_queries_all_replies': 12,
            'privacy_level': 0,
            'status': 'enabled',
            'gravity_last_updated': {
              'file_exists': true,
              'absolute': 17329,
              'relative': {'days': 4, 'hours': 23, 'minutes': 41},
            },
          }),
        );
      }

      // ------ summaryRaw + combined flags ------
      if (qp.containsKey('summaryRaw') &&
          (qp.containsKey('topItems') ||
              qp.containsKey('getForwardDestinations') ||
              qp.containsKey('getQuerySources') ||
              qp.containsKey('topClientsBlocked') ||
              qp.containsKey('getQueryTypes'))) {
        // http://example.com/admin/api.php?auth=xxx123&summaryRaw&topItems&...
        return Response.ok(
          jsonEncode({
            'domains_being_blocked': 121860,
            'dns_queries_today': 16,
            'ads_blocked_today': 1,
            'ads_percentage_today': 6.25,
            'unique_domains': 11,
            'queries_forwarded': 9,
            'queries_cached': 6,
            'clients_ever_seen': 2,
            'unique_clients': 2,
            'dns_queries_all_types': 16,
            'reply_UNKNOWN': 0,
            'reply_NODATA': 0,
            'reply_NXDOMAIN': 3,
            'reply_CNAME': 0,
            'reply_IP': 10,
            'reply_DOMAIN': 3,
            'reply_RRNAME': 0,
            'reply_SERVFAIL': 0,
            'reply_REFUSED': 0,
            'reply_NOTIMP': 0,
            'reply_OTHER': 0,
            'reply_DNSSEC': 0,
            'reply_NONE': 0,
            'reply_BLOB': 0,
            'dns_queries_all_replies': 16,
            'privacy_level': 0,
            'status': 'enabled',
            'gravity_last_updated': {
              'file_exists': true,
              'absolute': 1732972589,
              'relative': {'days': 5, 'hours': 18, 'minutes': 14},
            },
            'top_queries': {
              '1.0.26.172.in-addr.arpa': 3,
              '8.8.8.8.in-addr.arpa': 3,
              'github.com': 2,
              'gitlab.com': 1,
              'sample.com': 1,
              'test.com': 1,
              'google.com': 1,
              'google.co.jp': 1,
              'yahoo.co.jp': 1,
              'fix.test.com': 1,
            },
            'top_ads': {'test.com': 1},
            'top_sources': {'172.26.0.1': 10, 'localhost|127.0.0.1': 6},
            'top_sources_blocked': {'172.26.0.1': 1},
            'forward_destinations': {
              'blocked|blocked': 6.25,
              'cached|cached': 37.5,
              'other|other': 0,
              'dns.google#53|8.8.8.8#53': 56.25,
            },
            'querytypes': {
              'A (IPv4)': 62.5,
              'AAAA (IPv6)': 0,
              'ANY': 0,
              'SRV': 0,
              'SOA': 0,
              'PTR': 37.5,
              'TXT': 0,
              'NAPTR': 0,
              'MX': 0,
              'DS': 0,
              'RRSIG': 0,
              'DNSKEY': 0,
              'NS': 0,
              'OTHER': 0,
              'SVCB': 0,
              'HTTPS': 0,
            },
          }),
        );
      }

      // ------ overTime + clients + names ------
      if (qp.containsKey('overTimeData10mins') ||
          qp.containsKey('overTimeDataClients') ||
          qp.containsKey('getClientNames')) {
        // http://example.com/admin/api.php?auth=xxx123&overTimeData10mins&overTimeDataClients&getClientNames
        return Response.ok(
          jsonEncode({
            'domains_over_time': {
              '1733391300': 0,
              '1733391900': 0,
              '1733392500': 0,
              '1733393100': 0,
              '1733393700': 0,
              '1733394300': 0,
              '1733394900': 0,
              '1733395500': 0,
              '1733396100': 0,
              '1733396700': 3,
              '1733397300': 0,
              '1733397900': 0,
              '1733398500': 0,
              '1733399100': 0,
              '1733399700': 0,
              '1733400300': 2,
              '1733400900': 7,
              '1733401500': 0,
              '1733402100': 0,
              '1733402700': 0,
              '1733403300': 0,
              '1733403900': 2,
              '1733404500': 0,
              '1733405100': 0,
              '1733405700': 0,
              '1733406300': 0,
              '1733406900': 0,
              '1733407500': 2,
              '1733408100': 0,
              '1733408700': 0,
              '1733409300': 0,
              '1733409900': 0,
              '1733410500': 0,
              '1733411100': 0,
              '1733411700': 0,
              '1733412300': 0,
              '1733412900': 0,
              '1733413500': 0,
              '1733414100': 0,
              '1733414700': 0,
              '1733415300': 0,
              '1733415900': 0,
              '1733416500': 0,
              '1733417100': 0,
              '1733417700': 0,
              '1733418300': 0,
              '1733418900': 0,
              '1733419500': 0,
              '1733420100': 0,
              '1733420700': 0,
              '1733421300': 0,
              '1733421900': 0,
              '1733422500': 0,
              '1733423100': 0,
              '1733423700': 0,
              '1733424300': 0,
              '1733424900': 0,
              '1733425500': 0,
              '1733426100': 0,
              '1733426700': 0,
              '1733427300': 0,
              '1733427900': 0,
              '1733428500': 0,
              '1733429100': 0,
              '1733429700': 0,
              '1733430300': 0,
              '1733430900': 0,
              '1733431500': 0,
              '1733432100': 0,
              '1733432700': 0,
              '1733433300': 0,
              '1733433900': 0,
              '1733434500': 0,
              '1733435100': 0,
              '1733435700': 0,
              '1733436300': 0,
              '1733436900': 0,
              '1733437500': 0,
              '1733438100': 0,
              '1733438700': 0,
              '1733439300': 0,
              '1733439900': 0,
              '1733440500': 0,
              '1733441100': 0,
              '1733441700': 0,
              '1733442300': 0,
              '1733442900': 0,
              '1733443500': 0,
              '1733444100': 0,
              '1733444700': 0,
              '1733445300': 0,
              '1733445900': 0,
              '1733446500': 0,
              '1733447100': 0,
              '1733447700': 0,
              '1733448300': 0,
              '1733448900': 0,
              '1733449500': 0,
              '1733450100': 0,
              '1733450700': 0,
              '1733451300': 0,
              '1733451900': 0,
              '1733452500': 0,
              '1733453100': 0,
              '1733453700': 0,
              '1733454300': 0,
              '1733454900': 0,
              '1733455500': 0,
              '1733456100': 0,
              '1733456700': 0,
              '1733457300': 0,
              '1733457900': 0,
              '1733458500': 0,
              '1733459100': 0,
              '1733459700': 0,
              '1733460300': 0,
              '1733460900': 0,
              '1733461500': 0,
              '1733462100': 0,
              '1733462700': 0,
              '1733463300': 0,
              '1733463900': 0,
              '1733464500': 0,
              '1733465100': 0,
              '1733465700': 0,
              '1733466300': 0,
              '1733466900': 0,
              '1733467500': 0,
              '1733468100': 0,
              '1733468700': 0,
              '1733469300': 0,
              '1733469900': 0,
              '1733470500': 0,
              '1733471100': 0,
              '1733471700': 0,
              '1733472300': 0,
              '1733472900': 0,
              '1733473500': 0,
              '1733474100': 0,
              '1733474700': 0,
              '1733475300': 0,
              '1733475900': 0,
              '1733476500': 0,
              '1733477100': 0,
            },
            'ads_over_time': {
              '1733391300': 0,
              '1733391900': 0,
              '1733392500': 0,
              '1733393100': 0,
              '1733393700': 0,
              '1733394300': 0,
              '1733394900': 0,
              '1733395500': 0,
              '1733396100': 0,
              '1733396700': 0,
              '1733397300': 0,
              '1733397900': 0,
              '1733398500': 0,
              '1733399100': 0,
              '1733399700': 0,
              '1733400300': 0,
              '1733400900': 1,
              '1733401500': 0,
              '1733402100': 0,
              '1733402700': 0,
              '1733403300': 0,
              '1733403900': 0,
              '1733404500': 0,
              '1733405100': 0,
              '1733405700': 0,
              '1733406300': 0,
              '1733406900': 0,
              '1733407500': 0,
              '1733408100': 0,
              '1733408700': 0,
              '1733409300': 0,
              '1733409900': 0,
              '1733410500': 0,
              '1733411100': 0,
              '1733411700': 0,
              '1733412300': 0,
              '1733412900': 0,
              '1733413500': 0,
              '1733414100': 0,
              '1733414700': 0,
              '1733415300': 0,
              '1733415900': 0,
              '1733416500': 0,
              '1733417100': 0,
              '1733417700': 0,
              '1733418300': 0,
              '1733418900': 0,
              '1733419500': 0,
              '1733420100': 0,
              '1733420700': 0,
              '1733421300': 0,
              '1733421900': 0,
              '1733422500': 0,
              '1733423100': 0,
              '1733423700': 0,
              '1733424300': 0,
              '1733424900': 0,
              '1733425500': 0,
              '1733426100': 0,
              '1733426700': 0,
              '1733427300': 0,
              '1733427900': 0,
              '1733428500': 0,
              '1733429100': 0,
              '1733429700': 0,
              '1733430300': 0,
              '1733430900': 0,
              '1733431500': 0,
              '1733432100': 0,
              '1733432700': 0,
              '1733433300': 0,
              '1733433900': 0,
              '1733434500': 0,
              '1733435100': 0,
              '1733435700': 0,
              '1733436300': 0,
              '1733436900': 0,
              '1733437500': 0,
              '1733438100': 0,
              '1733438700': 0,
              '1733439300': 0,
              '1733439900': 0,
              '1733440500': 0,
              '1733441100': 0,
              '1733441700': 0,
              '1733442300': 0,
              '1733442900': 0,
              '1733443500': 0,
              '1733444100': 0,
              '1733444700': 0,
              '1733445300': 0,
              '1733445900': 0,
              '1733446500': 0,
              '1733447100': 0,
              '1733447700': 0,
              '1733448300': 0,
              '1733448900': 0,
              '1733449500': 0,
              '1733450100': 0,
              '1733450700': 0,
              '1733451300': 0,
              '1733451900': 0,
              '1733452500': 0,
              '1733453100': 0,
              '1733453700': 0,
              '1733454300': 0,
              '1733454900': 0,
              '1733455500': 0,
              '1733456100': 0,
              '1733456700': 0,
              '1733457300': 0,
              '1733457900': 0,
              '1733458500': 0,
              '1733459100': 0,
              '1733459700': 0,
              '1733460300': 0,
              '1733460900': 0,
              '1733461500': 0,
              '1733462100': 0,
              '1733462700': 0,
              '1733463300': 0,
              '1733463900': 0,
              '1733464500': 0,
              '1733465100': 0,
              '1733465700': 0,
              '1733466300': 0,
              '1733466900': 0,
              '1733467500': 0,
              '1733468100': 0,
              '1733468700': 0,
              '1733469300': 0,
              '1733469900': 0,
              '1733470500': 0,
              '1733471100': 0,
              '1733471700': 0,
              '1733472300': 0,
              '1733472900': 0,
              '1733473500': 0,
              '1733474100': 0,
              '1733474700': 0,
              '1733475300': 0,
              '1733475900': 0,
              '1733476500': 0,
              '1733477100': 0,
            },
            'clients': [
              {'name': '', 'ip': '172.26.0.1'},
              {'name': 'localhost', 'ip': '127.0.0.1'},
            ],
            'over_time': {
              '1733391300': [0, 0],
              '1733391900': [0, 0],
              '1733392500': [0, 0],
              '1733393100': [0, 0],
              '1733393700': [0, 0],
              '1733394300': [0, 0],
              '1733394900': [0, 0],
              '1733395500': [0, 0],
              '1733396100': [0, 0],
              '1733396700': [3, 0],
              '1733397300': [0, 0],
              '1733397900': [0, 0],
              '1733398500': [0, 0],
              '1733399100': [0, 0],
              '1733399700': [0, 0],
              '1733400300': [0, 2],
              '1733400900': [7, 0],
              '1733401500': [0, 0],
              '1733402100': [0, 0],
              '1733402700': [0, 0],
              '1733403300': [0, 0],
              '1733403900': [0, 2],
              '1733404500': [0, 0],
              '1733405100': [0, 0],
              '1733405700': [0, 0],
              '1733406300': [0, 0],
              '1733406900': [0, 0],
              '1733407500': [0, 2],
              '1733408100': [0, 0],
              '1733408700': [0, 0],
              '1733409300': [0, 0],
              '1733409900': [0, 0],
              '1733410500': [0, 0],
              '1733411100': [0, 0],
              '1733411700': [0, 0],
              '1733412300': [0, 0],
              '1733412900': [0, 0],
              '1733413500': [0, 0],
              '1733414100': [0, 0],
              '1733414700': [0, 0],
              '1733415300': [0, 0],
              '1733415900': [0, 0],
              '1733416500': [0, 0],
              '1733417100': [0, 0],
              '1733417700': [0, 0],
              '1733418300': [0, 0],
              '1733418900': [0, 0],
              '1733419500': [0, 0],
              '1733420100': [0, 0],
              '1733420700': [0, 0],
              '1733421300': [0, 0],
              '1733421900': [0, 0],
              '1733422500': [0, 0],
              '1733423100': [0, 0],
              '1733423700': [0, 0],
              '1733424300': [0, 0],
              '1733424900': [0, 0],
              '1733425500': [0, 0],
              '1733426100': [0, 0],
              '1733426700': [0, 0],
              '1733427300': [0, 0],
              '1733427900': [0, 0],
              '1733428500': [0, 0],
              '1733429100': [0, 0],
              '1733429700': [0, 0],
              '1733430300': [0, 0],
              '1733430900': [0, 0],
              '1733431500': [0, 0],
              '1733432100': [0, 0],
              '1733432700': [0, 0],
              '1733433300': [0, 0],
              '1733433900': [0, 0],
              '1733434500': [0, 0],
              '1733435100': [0, 0],
              '1733435700': [0, 0],
              '1733436300': [0, 0],
              '1733436900': [0, 0],
              '1733437500': [0, 0],
              '1733438100': [0, 0],
              '1733438700': [0, 0],
              '1733439300': [0, 0],
              '1733439900': [0, 0],
              '1733440500': [0, 0],
              '1733441100': [0, 0],
              '1733441700': [0, 0],
              '1733442300': [0, 0],
              '1733442900': [0, 0],
              '1733443500': [0, 0],
              '1733444100': [0, 0],
              '1733444700': [0, 0],
              '1733445300': [0, 0],
              '1733445900': [0, 0],
              '1733446500': [0, 0],
              '1733447100': [0, 0],
              '1733447700': [0, 0],
              '1733448300': [0, 0],
              '1733448900': [0, 0],
              '1733449500': [0, 0],
              '1733450100': [0, 0],
              '1733450700': [0, 0],
              '1733451300': [0, 0],
              '1733451900': [0, 0],
              '1733452500': [0, 0],
              '1733453100': [0, 0],
              '1733453700': [0, 0],
              '1733454300': [0, 0],
              '1733454900': [0, 0],
              '1733455500': [0, 0],
              '1733456100': [0, 0],
              '1733456700': [0, 0],
              '1733457300': [0, 0],
              '1733457900': [0, 0],
              '1733458500': [0, 0],
              '1733459100': [0, 0],
              '1733459700': [0, 0],
              '1733460300': [0, 0],
              '1733460900': [0, 0],
              '1733461500': [0, 0],
              '1733462100': [0, 0],
              '1733462700': [0, 0],
              '1733463300': [0, 0],
              '1733463900': [0, 0],
              '1733464500': [0, 0],
              '1733465100': [0, 0],
              '1733465700': [0, 0],
              '1733466300': [0, 0],
              '1733466900': [0, 0],
              '1733467500': [0, 0],
              '1733468100': [0, 0],
              '1733468700': [0, 0],
              '1733469300': [0, 0],
              '1733469900': [0, 0],
              '1733470500': [0, 0],
              '1733471100': [0, 0],
              '1733471700': [0, 0],
              '1733472300': [0, 0],
              '1733472900': [0, 0],
              '1733473500': [0, 0],
              '1733474100': [0, 0],
              '1733474700': [0, 0],
              '1733475300': [0, 0],
              '1733475900': [0, 0],
              '1733476500': [0, 0],
              '1733477100': [0, 0],
            },
          }),
        );
      }

      // ------ getAllQueries (with from/until) ------
      if (qp.containsKey('getAllQueries')) {
        // http://example.com/admin/api.php?auth=xxx123&getAllQueries=&from=...&until=...
        return Response.ok(
          jsonEncode({
            'data': [
              [
                '1733479389',
                'A',
                'google.com',
                '172.26.0.1',
                '2',
                '0',
                '4',
                '324',
                'N/A',
                '-1',
                'dns.google#53',
                '',
              ],
              [
                '1733479462',
                'A',
                'google.co.jp',
                '172.26.0.1',
                '2',
                '0',
                '4',
                '742',
                'N/A',
                '-1',
                'dns.google#53',
                '',
              ],
            ],
          }),
        );
      }

      // ------ list operations ------
      if (qp.containsKey('list')) {
        // e.g.
        //   ?list=white
        //   ?list=white&sub=google.com
        //   ?list=black&add=google.com
        final list = qp['list']; // white | regex_white | black | regex_black
        final add = qp['add'];
        final sub = qp['sub'];

        if (!['white', 'regex_white', 'black', 'regex_black'].contains(list)) {
          return Response.ok(
            jsonEncode(
              'Invalid list [supported: black, regex_black, white, regex_white]',
            ),
          );
        }

        if (sub != null) {
          return Response.ok(jsonEncode({'success': true, 'message': null}));
        }

        if (add != null) {
          return Response.ok(
            jsonEncode({'success': true, 'message': 'Added $add'}),
          );
        }

        // list = white, regex_white, black, regex_black の時異なるレスポンス返す
        if (list == 'white') {
          return Response.ok(
            jsonEncode({
              'data': [
                {
                  'id': 14,
                  'type': 0,
                  'domain': 'example.com',
                  'enabled': 1,
                  'date_added': 1733559182,
                  'date_modified': 1733559182,
                  'comment': '',
                  'groups': [0],
                },
              ],
            }),
          );
        } else if (list == 'regex_white') {
          return Response.ok(jsonEncode({'data': []}));
        } else if (list == 'black') {
          return Response.ok(
            jsonEncode({
              'data': [
                {
                  'id': 2,
                  'type': 1,
                  'domain': 'test.com',
                  'enabled': 1,
                  'date_added': 1733401118,
                  'date_modified': 1733496612,
                  'comment': 'てすと',
                  'groups': [0],
                },
              ],
            }),
          );
        } else if (list == 'regex_black') {
          return Response.ok(
            jsonEncode({
              'data': [
                {
                  'id': 21,
                  'type': 3,
                  'domain': r'test\.com$',
                  'enabled': 0,
                  'date_added': 1733401118,
                  'date_modified': 1733496612,
                  'comment': 'test',
                  'groups': [0, 1],
                },
              ],
            }),
          );
        }
      }

      // ------ versions ------
      if (qp.containsKey('versions')) {
        // http://example.com/admin/api.php?auth=xxx123&versions
        return Response.ok(
          jsonEncode({
            'core_update': false,
            'web_update': false,
            'FTL_update': false,
            'docker_update': true,
            'core_current': 'v5.18.3',
            'web_current': 'v5.21',
            'FTL_current': 'v5.25.2',
            'docker_current': '2024.07.0',
            'core_latest': 'v6.0.5',
            'web_latest': 'v6.0.2',
            'FTL_latest': 'v6.0.4',
            'docker_latest': '2025.03.0',
            'core_branch': 'master',
            'web_branch': 'master',
            'FTL_branch': 'master',
          }),
        );
      }

      // ------ default fallback ------
      return Response.ok(jsonEncode([]));
    });

    return router;
  }
}
